
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>drdmannturb.spectra_fitting.one_point_spectra &#8212; DRDMannTurb 0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="https://unpkg.com/d3/dist/d3.min.js"></script>
    <script>
            window.addEventListener("load", function () {
              var svgs = d3.selectAll(".mermaid svg");
              svgs.each(function() {
                var svg = d3.select(this);
                svg.html("<g>" + svg.html() + "</g>");
                var inner = svg.select("g");
                var zoom = d3.zoom().on("zoom", function(event) {
                  inner.attr("transform", event.transform);
                });
                svg.call(zoom);
              });
            });
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/drdmannturb/spectra_fitting/one_point_spectra';</script>
    <script src="../../../_static/require.min.js?v=8a87acde"></script>
    <script src="../../../_static/custom.js?v=9aa989ff"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">DRDMannTurb 0.1 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../getting-started.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../examples.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../forward_api.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../internal_api.html">
                        Internal API Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../getting-started.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../examples.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../forward_api.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../internal_api.html">
                        Internal API Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">drdmannturb....</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for drdmannturb.spectra_fitting.one_point_spectra</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="c1"># these imports are only needed for obtaining the exponential approximation of the Mann eddy lifetime function.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="kn">from</span> <span class="nn">..common</span> <span class="kn">import</span> <span class="n">Mann_linear_exponential_approx</span><span class="p">,</span> <span class="n">MannEddyLifetime</span><span class="p">,</span> <span class="n">VKEnergySpectrum</span>
<span class="kn">from</span> <span class="nn">..enums</span> <span class="kn">import</span> <span class="n">EddyLifetimeType</span><span class="p">,</span> <span class="n">PowerSpectraType</span>
<span class="kn">from</span> <span class="nn">..nn_modules</span> <span class="kn">import</span> <span class="n">CustomNet</span><span class="p">,</span> <span class="n">TauNet</span>
<span class="kn">from</span> <span class="nn">..parameters</span> <span class="kn">import</span> <span class="n">NNParameters</span><span class="p">,</span> <span class="n">PhysicalParameters</span>
<span class="kn">from</span> <span class="nn">.power_spectra_rdt</span> <span class="kn">import</span> <span class="n">PowerSpectraRDT</span>


<div class="viewcode-block" id="OnePointSpectra">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra">[docs]</a>
<span class="k">class</span> <span class="nc">OnePointSpectra</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    One point spectra implementation, including set-up of eddy lifetime function approximation with DRD models, or several classical eddy lifetime functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">type_eddy_lifetime</span><span class="p">:</span> <span class="n">EddyLifetimeType</span><span class="p">,</span>
        <span class="n">physical_params</span><span class="p">:</span> <span class="n">PhysicalParameters</span><span class="p">,</span>
        <span class="n">type_power_spectra</span><span class="p">:</span> <span class="n">PowerSpectraType</span> <span class="o">=</span> <span class="n">PowerSpectraType</span><span class="o">.</span><span class="n">RDT</span><span class="p">,</span>
        <span class="n">nn_parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NNParameters</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">learn_nu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialization of the one point spectra class. This requires the type of eddy lifetime function to use, the power spectra type (currently only the von Karman spectra is implemented), the neural network parameters to use if a DRD model is selected, and whether or not to learn :math:`\nu` in</span>

<span class="sd">        .. math::</span>
<span class="sd">            \tau(\boldsymbol{k})=\frac{T|\boldsymbol{a}|^{\nu-\frac{2}{3}}}{\left(1+|\boldsymbol{a}|^2\right)^{\nu / 2}}, \quad \boldsymbol{a}=\boldsymbol{a}(\boldsymbol{k}).</span>

<span class="sd">        Here,</span>

<span class="sd">        .. math::</span>
<span class="sd">            \boldsymbol{a}(\boldsymbol{k}):=\operatorname{abs}(\boldsymbol{k})+\mathrm{NN}(\operatorname{abs}(\boldsymbol{k}))</span>

<span class="sd">        if a neural network is used to learn the eddy lifetime function. For a discussion of the details and training, refer to the original DRD paper by Keith et al.</span>

<span class="sd">        Non-neural network eddy lifetime functions are provided as well, specifically the Mann model. The default power spectra used is due to von Karman.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type_eddy_lifetime : EddyLifetimeType, optional</span>
<span class="sd">            Type of eddy lifetime function :math:`\tau` to use.</span>
<span class="sd">        physical_params : PhysicalParameters,</span>
<span class="sd">            Object specifying physical parameters of the problem.</span>
<span class="sd">        type_power_spectra : PowerSpectraType, optional</span>
<span class="sd">            Type of power spectra function to use, by default PowerSpectraType.RDT, the only one currently implemented.</span>
<span class="sd">        nn_parameters : NNParameters, optional</span>
<span class="sd">            Dataclass containing neural network initialization if a neural network is used to approximate the eddy lifetime function, by default None.</span>
<span class="sd">        learn_nu : bool, optional</span>
<span class="sd">            Whether or not to learn :math:`\nu`, by default False.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            &quot;Selected neural network-based eddy lifetime function approximation but did not specify neural network parameters. Pass a constructed NNParameters object.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OnePointSpectra</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">type_eddy_lifetime</span>
            <span class="ow">in</span> <span class="p">[</span>
                <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">TAUNET</span><span class="p">,</span>
                <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">CUSTOMMLP</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="ow">and</span> <span class="n">nn_parameters</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Selected neural network-based eddy lifetime function approximation but did not specify neural network parameters. Pass a constructed NNParameters object.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">=</span> <span class="n">type_eddy_lifetime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_PowerSpectra</span> <span class="o">=</span> <span class="n">type_power_spectra</span>

        <span class="c1"># k2 grid</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span>
        <span class="n">grid_zero</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">grid_plus</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">grid_minus</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">grid_plus</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_k2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">grid_minus</span><span class="p">,</span> <span class="n">grid_zero</span><span class="p">,</span> <span class="n">grid_plus</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="c1"># k3 grid</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span>
        <span class="n">grid_zero</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">grid_plus</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">grid_minus</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">grid_plus</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_k3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">grid_minus</span><span class="p">,</span> <span class="n">grid_zero</span><span class="p">,</span> <span class="n">grid_plus</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid23</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_k2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_k3</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">physical_params</span><span class="o">.</span><span class="n">L</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Length scale L must be positive.&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">physical_params</span><span class="o">.</span><span class="n">Gamma</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;Characteristic time scale Gamma must be positive.&quot;</span>
        <span class="k">assert</span> <span class="n">physical_params</span><span class="o">.</span><span class="n">sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Spectrum amplitude sigma must be positive.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logLengthScale</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">physical_params</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logTimeScale</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">physical_params</span><span class="o">.</span><span class="n">Gamma</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logMagnitude</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">physical_params</span><span class="o">.</span><span class="n">sigma</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">TAUNET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tauNet</span> <span class="o">=</span> <span class="n">TauNet</span><span class="p">(</span>
                <span class="n">nn_parameters</span><span class="o">.</span><span class="n">nlayers</span><span class="p">,</span>
                <span class="n">nn_parameters</span><span class="o">.</span><span class="n">hidden_layer_size</span><span class="p">,</span>
                <span class="n">learn_nu</span><span class="o">=</span><span class="n">learn_nu</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">CUSTOMMLP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tauNet</span> <span class="o">=</span> <span class="n">CustomNet</span><span class="p">(</span>
                <span class="n">nn_parameters</span><span class="o">.</span><span class="n">nlayers</span><span class="p">,</span>
                <span class="n">nn_parameters</span><span class="o">.</span><span class="n">hidden_layer_sizes</span><span class="p">,</span>
                <span class="n">nn_parameters</span><span class="o">.</span><span class="n">activations</span><span class="p">,</span>
                <span class="n">learn_nu</span><span class="o">=</span><span class="n">learn_nu</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">MANN_APPROX</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_mann_linear_approx</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="OnePointSpectra.set_scales">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.set_scales">[docs]</a>
    <span class="k">def</span> <span class="nf">set_scales</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">LengthScale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">TimeScale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">Magnitude</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets scalar values for values used in non-dimensionalization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        LengthScale : np.float64</span>
<span class="sd">            Length scale.</span>
<span class="sd">        TimeScale : np.float64</span>
<span class="sd">            Time scale.</span>
<span class="sd">        Magnitude : np.float64</span>
<span class="sd">            Spectrum amplitude magnitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale_scalar</span> <span class="o">=</span> <span class="n">LengthScale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TimeScale_scalar</span> <span class="o">=</span> <span class="n">TimeScale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude_scalar</span> <span class="o">=</span> <span class="n">Magnitude</span></div>


<div class="viewcode-block" id="OnePointSpectra.exp_scales">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.exp_scales">[docs]</a>
    <span class="k">def</span> <span class="nf">exp_scales</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exponentiates the length, time, and spectrum amplitude scales,</span>

<span class="sd">        .. note::</span>
<span class="sd">            The first 3 parameters of self.parameters() are exactly</span>
<span class="sd">                - LengthScale</span>
<span class="sd">                - TimeScale</span>
<span class="sd">                - SpectrumAmplitude</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[float, float, float]</span>
<span class="sd">           Scalar values for each of the length, time, and magnitude scales, in that order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logLengthScale</span><span class="p">)</span>  <span class="c1"># NOTE: this is L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TimeScale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logTimeScale</span><span class="p">)</span>  <span class="c1"># NOTE: this is gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logMagnitude</span><span class="p">)</span>  <span class="c1"># NOTE: this is sigma</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimeScale</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>


<div class="viewcode-block" id="OnePointSpectra.forward">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1_input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluation of one point spectra</span>

<span class="sd">        .. math::</span>
<span class="sd">            \widetilde{J}_i(f ; \boldsymbol{\theta})=C k_1 \widetilde{F}_{i i}\left(k_1 z ; \boldsymbol{\theta}\right),</span>

<span class="sd">        defined by equations 6 (a-d) in the original DRD paper. Here,</span>

<span class="sd">        .. math::</span>
<span class="sd">            \widetilde{F}_{i j}\left(k_1 ; \boldsymbol{\theta}\right)=\int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \Phi_{i j}^{\mathrm{DRD}}(\boldsymbol{k}, \boldsymbol{\theta}) \mathrm{d} k_2 \mathrm{~d} k_3.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k1_input : torch.Tensor</span>
<span class="sd">            Discrete :math:`k_1` wavevector domain.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Network output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_scales</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">k1_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_k2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_k3</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k123</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EddyLifetime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">k0L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">VKEnergySpectrum</span><span class="p">(</span><span class="n">k0L</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PowerSpectra</span><span class="p">()</span>
        <span class="n">kF</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">k1_input</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad23</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span> <span class="k">for</span> <span class="n">Phi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">kF</span></div>


<div class="viewcode-block" id="OnePointSpectra.init_mann_approximation">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.init_mann_approximation">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mann_approximation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initializes Mann eddy lifetime function approximation by performing a linear regression in log-log space on</span>
<span class="sd">        a given wave space and the true output of</span>

<span class="sd">        .. math::</span>
<span class="sd">           \frac{x^{-\frac{2}{3}}}{\sqrt{{ }_2 F_1\left(1 / 3,17 / 6 ; 4 / 3 ;-x^{-2}\right)}}</span>

<span class="sd">        This operation is performed once on the CPU.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kL_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">kL_temp</span> <span class="o">=</span> <span class="n">kL_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tau_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TimeScale_scalar</span> <span class="o">*</span> <span class="n">MannEddyLifetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LengthScale_scalar</span> <span class="o">*</span> <span class="n">kL_temp</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">kL_temp_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kL_temp</span><span class="p">)</span>

        <span class="n">regressor</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="c1"># fits in log-log space since tau is nearly linear in log-log</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">kL_temp_log</span><span class="p">,</span> <span class="n">tau_true</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mann Linear Approximation R2 Score in log-log space: </span><span class="si">{</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">kL_temp_log</span><span class="p">,</span><span class="w"> </span><span class="n">tau_true</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tau_approx_coeff_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_approx_intercept_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_mann_linear_approx</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="OnePointSpectra.EddyLifetime">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.EddyLifetime">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">export</span>
    <span class="k">def</span> <span class="nf">EddyLifetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluation of eddy lifetime function :math:`\tau` constructed during object initialization. This may be the Mann model or a DRD neural network that learns :math:`\tau`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : Optional[torch.Tensor], optional</span>
<span class="sd">            Wavevector domain on which to evaluate the eddy lifetime function, by default None, which defaults to grids in logspace(-3, 3).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Evaluation of current eddylifetime function on provided domain.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            Did not specify an admissible EddyLifetime model. Refer to the EddyLifetimeType documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp_scales</span><span class="p">()</span>

        <span class="n">kL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale</span> <span class="o">*</span> <span class="n">k</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;init_mann_linear_approx&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mann_linear_approx</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="p">):</span>  <span class="c1"># Mann approximation chosen but not initialized</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_mann_approximation</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">CONST</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">kL</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">MANN</span>
        <span class="p">):</span>  <span class="c1"># uses numpy - can not be backpropagated, also CPU only.</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">MannEddyLifetime</span><span class="p">(</span><span class="n">kL</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">MANN_APPROX</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">Mann_linear_exponential_approx</span><span class="p">(</span>
                <span class="n">kL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_approx_coeff_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_approx_intercept_</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="o">==</span> <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">TWOTHIRD</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">kL</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_EddyLifetime</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">TAUNET</span><span class="p">,</span>
            <span class="n">EddyLifetimeType</span><span class="o">.</span><span class="n">CUSTOMMLP</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">tau0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialGuess_EddyLifetime</span><span class="p">()</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">tau0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauNet</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LengthScale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Did not specify an admissible EddyLifetime model. Refer to the EddyLifetimeType documentation.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimeScale</span> <span class="o">*</span> <span class="n">tau</span></div>


<div class="viewcode-block" id="OnePointSpectra.InitialGuess_EddyLifetime">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.InitialGuess_EddyLifetime">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">export</span>
    <span class="k">def</span> <span class="nf">InitialGuess_EddyLifetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial guess at the eddy lifetime function which the DRD model uses in learning the :math:`\tau` eddy lifetime function. By default, this is just the :math:`0` function, but later functionality may allow this to be dynamically set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Initial guess evaluation, presently, the :math:`0` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="mf">0.0</span></div>


<div class="viewcode-block" id="OnePointSpectra.PowerSpectra">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.PowerSpectra">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">export</span>
    <span class="k">def</span> <span class="nf">PowerSpectra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls the RDT Power Spectra model with current approximation of the eddy lifetime function and the energy spectrum.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            RDT power spectra evaluation.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            In the case that the Power Spectra is not RDT</span>
<span class="sd">            and therefore incorrect.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_PowerSpectra</span> <span class="o">==</span> <span class="n">PowerSpectraType</span><span class="o">.</span><span class="n">RDT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PowerSpectraRDT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incorrect PowerSpectra model !&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OnePointSpectra.quad23">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.quad23">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">export</span>
    <span class="k">def</span> <span class="nf">quad23</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes an approximation of the integral of the discretized function :math:`f` in the dimensions defined by :math:`k_2` and :math:`k_3` using the trapezoidal rule:</span>

<span class="sd">        .. math::</span>
<span class="sd">            \int \int f(k_1 ; \mathbf{\theta}) d k_2 dk_3.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : torch.Tensor</span>
<span class="sd">            Function evaluation (tensor) to integrate over the frequency domain constructed during initialization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Evaluated double integral.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Integration in k3</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># NOTE: Integration in k2 (fixed k3=0, since slices are identical in meshgrid)</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">quad</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">quad</span></div>


<div class="viewcode-block" id="OnePointSpectra.get_div">
<a class="viewcode-back" href="../../../calibration.html#drdmannturb.OnePointSpectra.get_div">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">export</span>
    <span class="k">def</span> <span class="nf">get_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Phi</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the divergence of an evaluated spectral tensor. This is evaluated simply as :math:`\textbf{k} \cdot \Phi_{\textbf{k}}` and normalized by the trace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Phi : torch.Tensor</span>
<span class="sd">            Discrete evaluated spectral tensor :math:`\Phi(\textbf{k}, \tau)`, which may or may not depend on the eddy lifetime function. For instance, if the von Karman model is used, no :math:`\tau` dependence is present.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Divergence of the spectral tensor in the frequency domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">Phi11</span><span class="p">,</span> <span class="n">Phi22</span><span class="p">,</span> <span class="n">Phi33</span><span class="p">,</span> <span class="n">Phi13</span><span class="p">,</span> <span class="n">Phi12</span><span class="p">,</span> <span class="n">Phi23</span> <span class="o">=</span> <span class="n">Phi</span>
        <span class="n">div</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">k1</span> <span class="o">*</span> <span class="n">Phi11</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">Phi12</span> <span class="o">+</span> <span class="n">k3</span> <span class="o">*</span> <span class="n">Phi13</span><span class="p">,</span>
                <span class="n">k1</span> <span class="o">*</span> <span class="n">Phi12</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">Phi22</span> <span class="o">+</span> <span class="n">k3</span> <span class="o">*</span> <span class="n">Phi23</span><span class="p">,</span>
                <span class="n">k1</span> <span class="o">*</span> <span class="n">Phi13</span> <span class="o">+</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">Phi23</span> <span class="o">+</span> <span class="n">k3</span> <span class="o">*</span> <span class="n">Phi33</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">Phi11</span> <span class="o">+</span> <span class="n">Phi22</span> <span class="o">+</span> <span class="n">Phi33</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">div</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright Alexey Izmailov, Matthew Meeker.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>